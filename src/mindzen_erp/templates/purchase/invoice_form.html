{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Invoice Header -->
    <div class="card shadow-lg border-0 rounded-4 mb-4">
        <div class="card-body p-4 p-lg-5">
            <div class="row align-items-center mb-4">
                <div class="col-6">
                    <h1 class="h2 fw-bold text-gradient mb-0">Purchase Invoice</h1>
                    <p class="text-muted mb-0">Vendor Bill Entry (Zakat Compliant)</p>
                </div>
                <div class="col-6 text-end">
                    <div class="d-inline-flex align-items-center bg-light rounded-pill px-3 py-2">
                        <label class="small fw-bold text-secondary me-2 mb-0">DATE:</label>
                        <span class="fw-bold">{{ date_today }}</span>
                    </div>
                </div>
            </div>

            <form id="purchaseForm">
                <div class="row g-4 mb-5">
                    <div class="col-md-6">
                        <div class="p-4 bg-light rounded-4 h-100">
                            <label class="form-label small fw-bold text-uppercase text-secondary mb-3">Vendor
                                Details</label>
                            <select id="vendorSelect"
                                class="form-select form-select-lg border-0 shadow-sm rounded-3 mb-3">
                                <option value="">Select Vendor...</option>
                                {% for vendor in vendors %}
                                <option value="{{ vendor.id }}">{{ vendor.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-4 bg-light rounded-4 h-100">
                            <label class="form-label small fw-bold text-uppercase text-secondary mb-3">Payment
                                Options</label>
                            <div class="row g-3">
                                <div class="col-6">
                                    <label class="small text-muted mb-1">Bill Type</label>
                                    <select class="form-select border-0 shadow-sm rounded-3">
                                        <option>Standard Bill</option>
                                        <option>Expense Voucher</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="small text-muted mb-1">Payment Method</label>
                                    <select class="form-select border-0 shadow-sm rounded-3">
                                        <option>Credit</option>
                                        <option>Cash</option>
                                        <option>Bank Transfer</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Entry Table -->
                <div class="table-responsive mb-5">
                    <table class="table align-middle" id="itemsTable">
                        <thead class="text-secondary small fw-bold text-uppercase">
                            <tr>
                                <th style="width: 40%;">Product / Description</th>
                                <th style="width: 15%;">UOM</th>
                                <th style="width: 15%;">Qty</th>
                                <th style="width: 15%;">Cost (SAR)</th>
                                <th style="width: 15%;" class="text-end">Amount</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="invoiceItems">
                            <tr class="item-row">
                                <td>
                                    <select class="form-select product-select border-0 bg-transparent fw-bold p-0 mb-1">
                                        <option value="">Choose Item...</option>
                                        {% for product in products %}
                                        <option value="{{ product.id }}" data-rate="{{ product.cost_rate or 0 }}">{{
                                            product.name }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <select class="form-select uom-select border-0 bg-transparent p-0">
                                        <option>Single (Pc)</option>
                                        <option>Carton (Box)</option>
                                    </select>
                                </td>
                                <td><input type="number"
                                        class="form-control qty-input border-0 bg-transparent p-0 fw-bold" value="1">
                                </td>
                                <td><input type="number"
                                        class="form-control rate-input border-0 bg-transparent p-0 fw-bold"
                                        value="0.00"></td>
                                <td class="text-end fw-bold"><span class="item-total">0.00</span></td>
                                <td class="text-end">
                                    <button type="button" class="btn btn-sm text-danger remove-row"><i
                                            class="fas fa-times"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-light-primary rounded-pill btn-sm" id="addRow">
                        <i class="fas fa-plus me-1"></i> Add Item
                    </button>
                </div>

                <!-- Footer Summary -->
                <div class="row pt-4 border-top">
                    <div class="col-md-6">
                        <textarea class="form-control border-0 bg-light rounded-4 p-3" rows="3"
                            placeholder="Bill Notes..."></textarea>
                    </div>
                    <div class="col-md-5 offset-md-1">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Subtotal</span>
                            <span class="fw-bold fs-5" id="subtotal">SAR 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">VAT (15%)</span>
                            <span class="fw-bold text-primary" id="taxAmount">SAR 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3 pt-3 border-top">
                            <span class="h4 fw-bold">TOTAL PAYABLE</span>
                            <span class="h4 fw-bold text-gradient" id="grandTotal">SAR 0.00</span>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill btn-lg shadow-sm">
                            Save Purchase Invoice <i class="fas fa-save ms-2"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tableBody = document.getElementById('invoiceItems');
        const addRowBtn = document.getElementById('addRow');

        function calculate() {
            let subtotal = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
                const rate = parseFloat(row.querySelector('.rate-input').value) || 0;
                const total = qty * rate;
                row.querySelector('.item-total').textContent = total.toFixed(2);
                subtotal += total;
            });

            const tax = subtotal * 0.15;
            const grandTotal = subtotal + tax;

            document.getElementById('subtotal').textContent = 'SAR ' + subtotal.toFixed(2);
            document.getElementById('taxAmount').textContent = 'SAR ' + tax.toFixed(2);
            document.getElementById('grandTotal').textContent = 'SAR ' + grandTotal.toFixed(2);
        }

        addRowBtn.addEventListener('click', () => {
            const firstRow = tableBody.querySelector('.item-row');
            const newRow = firstRow.cloneNode(true);
            newRow.querySelectorAll('input').forEach(i => i.value = i.defaultValue);
            tableBody.appendChild(newRow);
            attachEvents(newRow);
        });

        function attachEvents(row) {
            row.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', calculate);
            });

            const productSelect = row.querySelector('.product-select');
            productSelect.addEventListener('change', function () {
                const selected = this.options[this.selectedIndex];
                const rate = selected.getAttribute('data-rate') || 0;
                row.querySelector('.rate-input').value = rate;
                calculate();
            });

            row.querySelector('.remove-row').addEventListener('click', function () {
                if (tableBody.querySelectorAll('.item-row').length > 1) {
                    row.remove();
                    calculate();
                }
            });
        }

        document.getElementById('purchaseForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';

            const vendorId = document.getElementById('vendorSelect').value;
            if (!vendorId) {
                alert("Please select a vendor");
                submitBtn.disabled = false;
                return;
            }

            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const prodId = row.querySelector('.product-select').value;
                if (prodId) {
                    items.push({
                        product_id: parseInt(prodId),
                        uom_id: 1,
                        qty: parseFloat(row.querySelector('.qty-input').value),
                        rate: parseFloat(row.querySelector('.rate-input').value)
                    });
                }
            });

            if (items.length === 0) {
                alert("Please add at least one product");
                submitBtn.disabled = false;
                return;
            }

            const payload = {
                vendor_id: parseInt(vendorId),
                notes: document.querySelector('textarea').value,
                items: items
            };

            try {
                const response = await fetch('/purchase/invoices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("Purchase Invoice Created Successfully!");
                    window.location.href = '/purchase';
                } else {
                    alert("Error saving invoice");
                }
            } catch (err) {
                console.error(err);
                alert("Network error");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Save Purchase Invoice <i class="fas fa-save ms-2"></i>';
            }
        });

        document.querySelectorAll('.item-row').forEach(attachEvents);
    });
</script>

<style>
    .text-gradient {
        background: linear-gradient(45deg, #10b981, #34d399);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .btn-light-primary {
        background-color: rgba(16, 185, 129, 0.05);
        color: #059669;
        border: none;
    }

    .btn-light-primary:hover {
        background-color: rgba(16, 185, 129, 0.1);
    }
</style>
{% endblock %}